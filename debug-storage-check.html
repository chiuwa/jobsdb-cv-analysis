<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome Storage CV Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        pre {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #005a87;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #0066cc;
            background: #e6f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .size-highlight {
            font-weight: bold;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Chrome Storage CV Debug Tool</h1>
        
        <div class="info">
            é€™å€‹å·¥å…·å¯ä»¥å¹«åŠ©æª¢æŸ¥Chromeæ“´å±•ç¨‹å¼ä¸­CVæ–‡ä»¶çš„å¯¦éš›å­˜å„²æ•¸æ“šï¼Œæ‰¾å‡º0Bå¤§å°å•é¡Œçš„æ ¹æºã€‚
        </div>

        <div class="section">
            <h3>ğŸ—‚ï¸ Chrome Storage æª¢æŸ¥</h3>
            <button onclick="checkChromeStorage()">æª¢æŸ¥ Chrome Storage</button>
            <button onclick="clearChromeStorage()">æ¸…é™¤ Chrome Storage</button>
            <button onclick="exportStorageData()">å°å‡ºå­˜å„²æ•¸æ“š</button>
            <div id="storage-result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“Š CV æ•¸æ“šåˆ†æ</h3>
            <button onclick="analyzeCVData()">åˆ†æCVæ•¸æ“š</button>
            <div id="analysis-result"></div>
        </div>

        <div class="section">
            <h3>ğŸ§ª æ¸¬è©¦æ–‡ä»¶ä¸Šå‚³</h3>
            <input type="file" id="test-file" accept=".pdf" />
            <button onclick="testFileReading()">æ¸¬è©¦æ–‡ä»¶è®€å–</button>
            <div id="test-result"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ æ“ä½œæ—¥èªŒ</h3>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
            <div id="log-output"></div>
        </div>
    </div>

    <script>
        let logOutput = [];

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logOutput.push(logEntry);
            
            if (data) {
                logOutput.push(`Data: ${JSON.stringify(data, null, 2)}`);
            }
            
            updateLogDisplay();
            console.log(logEntry, data);
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('log-output');
            logDiv.innerHTML = '<pre>' + logOutput.slice(-20).join('\n') + '</pre>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            logOutput = [];
            updateLogDisplay();
        }

        async function checkChromeStorage() {
            try {
                log('é–‹å§‹æª¢æŸ¥Chrome Storage...');
                
                // ä½¿ç”¨Chrome Extension APIç²å–å­˜å„²æ•¸æ“š
                const result = await chrome.storage.local.get(null);
                
                log('Chrome Storageæª¢æŸ¥å®Œæˆ', {
                    keys: Object.keys(result),
                    totalKeys: Object.keys(result).length
                });

                let html = '<h4>å­˜å„²å…§å®¹ï¼š</h4>';
                
                if (result.cvList) {
                    html += '<h5>CVåˆ—è¡¨ï¼š</h5>';
                    html += '<table>';
                    html += '<tr><th>ID</th><th>åç¨±</th><th>è²æ˜å¤§å°</th><th>å¯¦éš›å¤§å°</th><th>é¡å‹</th><th>Base64é•·åº¦</th></tr>';
                    
                    result.cvList.forEach(cv => {
                        const base64Length = cv.contentBase64 ? cv.contentBase64.length : 0;
                        const estimatedSize = base64Length > 0 ? Math.floor(base64Length * 3 / 4) : 0;
                        const sizeMatch = cv.size === estimatedSize;
                        
                        html += `<tr>
                            <td>${cv.id.substring(0, 8)}...</td>
                            <td>${cv.name}</td>
                            <td class="${cv.size === 0 ? 'size-highlight' : ''}">${cv.size} bytes</td>
                            <td class="${!sizeMatch ? 'size-highlight' : ''}">${estimatedSize} bytes</td>
                            <td>${cv.type}</td>
                            <td>${base64Length}</td>
                        </tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<p>æ²’æœ‰æ‰¾åˆ°CVåˆ—è¡¨</p>';
                }

                if (result.currentCV) {
                    html += '<h5>ç•¶å‰CVï¼š</h5>';
                    const currentCV = result.currentCV;
                    const base64Length = currentCV.contentBase64 ? currentCV.contentBase64.length : 0;
                    const estimatedSize = base64Length > 0 ? Math.floor(base64Length * 3 / 4) : 0;
                    
                    html += `<p>åç¨±: ${currentCV.name}</p>`;
                    html += `<p>è²æ˜å¤§å°: <span class="${currentCV.size === 0 ? 'size-highlight' : ''}">${currentCV.size} bytes</span></p>`;
                    html += `<p>ä¼°ç®—å¤§å°: ${estimatedSize} bytes</p>`;
                    html += `<p>Base64é•·åº¦: ${base64Length}</p>`;
                    html += `<p>æœ‰å…§å®¹: ${!!currentCV.contentBase64}</p>`;
                }

                document.getElementById('storage-result').innerHTML = html;

            } catch (error) {
                log('æª¢æŸ¥Chrome Storageå¤±æ•—', error);
                document.getElementById('storage-result').innerHTML = 
                    `<div class="error">éŒ¯èª¤: ${error.message}</div>`;
            }
        }

        async function clearChromeStorage() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰Chrome Storageæ•¸æ“šå—ï¼Ÿ')) {
                return;
            }
            
            try {
                await chrome.storage.local.clear();
                log('Chrome Storageå·²æ¸…é™¤');
                document.getElementById('storage-result').innerHTML = 
                    '<div class="info">Chrome Storageå·²æ¸…é™¤</div>';
            } catch (error) {
                log('æ¸…é™¤Chrome Storageå¤±æ•—', error);
                document.getElementById('storage-result').innerHTML = 
                    `<div class="error">æ¸…é™¤å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function exportStorageData() {
            try {
                const result = await chrome.storage.local.get(null);
                
                // å‰µå»ºä¸åŒ…å«base64å…§å®¹çš„è¼•é‡ç‰ˆæœ¬ç”¨æ–¼å°å‡º
                const exportData = JSON.parse(JSON.stringify(result));
                if (exportData.cvList) {
                    exportData.cvList.forEach(cv => {
                        if (cv.contentBase64) {
                            cv.base64Length = cv.contentBase64.length;
                            cv.contentBase64 = cv.contentBase64.substring(0, 100) + '...[truncated]';
                        }
                    });
                }
                if (exportData.currentCV && exportData.currentCV.contentBase64) {
                    exportData.currentCV.base64Length = exportData.currentCV.contentBase64.length;
                    exportData.currentCV.contentBase64 = exportData.currentCV.contentBase64.substring(0, 100) + '...[truncated]';
                }

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `chrome-storage-debug-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                log('å­˜å„²æ•¸æ“šå·²å°å‡º');
            } catch (error) {
                log('å°å‡ºå­˜å„²æ•¸æ“šå¤±æ•—', error);
            }
        }

        async function analyzeCVData() {
            try {
                const result = await chrome.storage.local.get(['cvList', 'currentCV']);
                
                let analysis = {
                    totalCVs: 0,
                    totalDeclaredSize: 0,
                    totalEstimatedSize: 0,
                    problematicCVs: [],
                    validCVs: []
                };

                if (result.cvList) {
                    analysis.totalCVs = result.cvList.length;
                    
                    result.cvList.forEach(cv => {
                        const declaredSize = Number(cv.size) || 0;
                        const base64Length = cv.contentBase64 ? cv.contentBase64.length : 0;
                        const estimatedSize = base64Length > 0 ? Math.floor(base64Length * 3 / 4) : 0;
                        
                        analysis.totalDeclaredSize += declaredSize;
                        analysis.totalEstimatedSize += estimatedSize;
                        
                        if (declaredSize === 0 || Math.abs(declaredSize - estimatedSize) > 1000) {
                            analysis.problematicCVs.push({
                                name: cv.name,
                                declaredSize,
                                estimatedSize,
                                base64Length,
                                hasContent: !!cv.contentBase64
                            });
                        } else {
                            analysis.validCVs.push({
                                name: cv.name,
                                size: declaredSize
                            });
                        }
                    });
                }

                log('CVæ•¸æ“šåˆ†æå®Œæˆ', analysis);

                let html = '<h4>åˆ†æçµæœï¼š</h4>';
                html += `<p>ç¸½CVæ•¸é‡: ${analysis.totalCVs}</p>`;
                html += `<p>è²æ˜ç¸½å¤§å°: ${analysis.totalDeclaredSize} bytes</p>`;
                html += `<p>ä¼°ç®—ç¸½å¤§å°: ${analysis.totalEstimatedSize} bytes</p>`;
                
                if (analysis.problematicCVs.length > 0) {
                    html += '<h5 class="size-highlight">å•é¡ŒCV:</h5>';
                    html += '<table>';
                    html += '<tr><th>åç¨±</th><th>è²æ˜å¤§å°</th><th>ä¼°ç®—å¤§å°</th><th>Base64é•·åº¦</th><th>æœ‰å…§å®¹</th></tr>';
                    analysis.problematicCVs.forEach(cv => {
                        html += `<tr>
                            <td>${cv.name}</td>
                            <td class="size-highlight">${cv.declaredSize}</td>
                            <td>${cv.estimatedSize}</td>
                            <td>${cv.base64Length}</td>
                            <td>${cv.hasContent ? 'æ˜¯' : 'å¦'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                if (analysis.validCVs.length > 0) {
                    html += '<h5>æ­£å¸¸CV:</h5>';
                    html += '<ul>';
                    analysis.validCVs.forEach(cv => {
                        html += `<li>${cv.name} (${cv.size} bytes)</li>`;
                    });
                    html += '</ul>';
                }

                document.getElementById('analysis-result').innerHTML = html;

            } catch (error) {
                log('åˆ†æCVæ•¸æ“šå¤±æ•—', error);
                document.getElementById('analysis-result').innerHTML = 
                    `<div class="error">åˆ†æå¤±æ•—: ${error.message}</div>`;
            }
        }

        async function testFileReading() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹PDFæ–‡ä»¶');
                return;
            }

            try {
                log(`é–‹å§‹æ¸¬è©¦æ–‡ä»¶è®€å–: ${file.name} (${file.size} bytes)`);

                // æ¸¬è©¦ ArrayBuffer è®€å–
                const arrayBufferResult = await readFileAsArrayBuffer(file);
                log('ArrayBufferè®€å–å®Œæˆ', {
                    originalSize: file.size,
                    arrayBufferSize: arrayBufferResult.byteLength,
                    sizesMatch: file.size === arrayBufferResult.byteLength
                });

                // æ¸¬è©¦ Base64 è®€å–
                const base64Result = await readFileAsBase64(file);
                const estimatedSize = Math.floor(base64Result.length * 3 / 4);
                log('Base64è®€å–å®Œæˆ', {
                    originalSize: file.size,
                    base64Length: base64Result.length,
                    estimatedSize: estimatedSize,
                    sizesMatch: Math.abs(file.size - estimatedSize) < 10
                });

                // æ¸¬è©¦ File é‡å»º
                const reconstructedFile = new File([arrayBufferResult], file.name, {
                    type: file.type,
                    lastModified: file.lastModified
                });
                log('Fileé‡å»ºå®Œæˆ', {
                    originalSize: file.size,
                    reconstructedSize: reconstructedFile.size,
                    sizesMatch: file.size === reconstructedFile.size
                });

                let html = '<h4>æ¸¬è©¦çµæœï¼š</h4>';
                html += `<p>åŸå§‹æ–‡ä»¶: ${file.name} (${file.size} bytes)</p>`;
                html += `<p>ArrayBufferå¤§å°: ${arrayBufferResult.byteLength} bytes</p>`;
                html += `<p>Base64é•·åº¦: ${base64Result.length}</p>`;
                html += `<p>Base64ä¼°ç®—å¤§å°: ${estimatedSize} bytes</p>`;
                html += `<p>é‡å»ºæ–‡ä»¶å¤§å°: ${reconstructedFile.size} bytes</p>`;

                document.getElementById('test-result').innerHTML = html;

            } catch (error) {
                log('æ¸¬è©¦æ–‡ä»¶è®€å–å¤±æ•—', error);
                document.getElementById('test-result').innerHTML = 
                    `<div class="error">æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => resolve(event.target.result);
                reader.onerror = error => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    const base64 = event.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // æª¢æŸ¥æ˜¯å¦åœ¨Chromeæ“´å±•ç’°å¢ƒä¸­
        if (typeof chrome !== 'undefined' && chrome.storage) {
            log('Chromeæ“´å±•ç’°å¢ƒæª¢æ¸¬æˆåŠŸ');
        } else {
            document.body.innerHTML = `
                <div class="container">
                    <div class="error">
                        <h2>âš ï¸ éŒ¯èª¤</h2>
                        <p>æ­¤å·¥å…·éœ€è¦åœ¨Chromeæ“´å±•ç’°å¢ƒä¸­é‹è¡Œã€‚è«‹å°‡æ­¤æ–‡ä»¶æ·»åŠ åˆ°æ“´å±•ç¨‹å¼ä¸­ï¼Œç„¶å¾Œé€šéæ“´å±•ç¨‹å¼è¨ªå•ã€‚</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html> 